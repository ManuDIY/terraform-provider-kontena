## Build

Requires Go 1.8 for [`github.com/hashicorp/terraform`](https://github.com/hashicorp/terraform#developing-terraform):

> If you wish to work on Terraform itself or any of its built-in providers, you'll first need Go installed on your machine (version 1.8+ is required).

```
$ export GOPATH=~/go
$ mkdir -p $GOPATH/src/github.com/kontena/
$ ln -s $PWD $GOPATH/src/github.com/kontena/terraform-provider-kontena
$ go get -v -d -t ./... && go test ./... && go install -v ./providers/...
```

Resulting binaries under `$GOPATH/bin`:

* `terraform-provider-kontena`
* `terraform-provider-kontena-oauth2`

## Setup

Configure terraform to use the custom providers:

#### `~/.terraformrc`

```
providers {
  kontena = "/home/.../go/bin/terraform-provider-kontena"
  kontena-oauth2 = "/home/.../go/bin/terraform-provider-kontena-oauth2"
}
```

Note that `.terraformrc` does not support `~/go` path expansion.

## Usage

### `kontena.tf`

Using the oauth2 token generated by `kontena-oauth2_token`:

```
provider "kontena" {
  url = "http://X.Y.Z.W:80"
  token = "cc1f...fb6417"
}

resource "kontena_grid" "test" {
  name = "test"
  initial_size = 1
  trusted_subnets = [ "192.168.66.0/24" ]
}

resource "kontena_node" "node" {
  count = "${var.digitalocean_node_count}"

  grid = "${kontena_grid.grid.name}"
  name = "terraform-test-node${count.index + 1}"

  labels = [
    "provider=digitalocean",
    "region=${var.digitalocean-region}",
    "az=${var.digitalocean-region}",
  ]
}

output "grid_token" {
  value = "${kontena_grid.grid.token}"
}
output "node_token" {
  value = "${kontena_node.node.token}"
}
```

### Bootstrapping oauth2 token from the  `INITIAL_ADMIN_CODE`

If you are provisioning the master itself via terraform with a pre-configured `INITIAL_ADMIN_CODE`, you can use the `kontena_token` resource to exchange the inital admin code for the admin token. You must use a second, aliased instance of the provider to do this:


```
module "digitalocean_master" {
  ...
}

provider "kontena" {
  alias = "master-bootstrap"
  url = "${module.digitalocean_master.http_url}"
}

resource "kontena_token" "admin" {
  provider = "kontena.master-bootstrap"

  code = "${var.kontena-initial_admin_code}"
}

provider "kontena" {
  url = "${module.digitalocean_master.http_url}"
  token = "${kontena_token.admin.token}"
}

output "KONTENA_URI" {
  value = "${module.digitalocean_master.http_url}"
}

output "KOTNENA_TOKEN" {
  value = "${kontena_token.admin.token}"
}
```

## Example
### `terraform show`
```
kontena-oauth2_token.admin:
  id = b0...17
  code = bsF...NBN
  token = b08....5ad17
kontena_grid.grid:
  id = test
  default_affinity.# = 0
  initial_size = 1
  name = test
  subnet = 10.81.0.0/16
  supernet = 10.80.0.0/12
  token = baCP...qt+mpw==
  trusted_subnets.# = 0
kontena_node.node:
  id = test/terraform-test-node1
  agent_version = 1.3.0
  docker_version = 1.12.6
  grid = test
  initial_node = true
  labels.# = 0
  name = terraform-test-node1
  node_number = 1
  overlay_ip = 10.81.0.1
  private_ip = 138.68.79.119
  public_ip = 138.68.79.119
```
